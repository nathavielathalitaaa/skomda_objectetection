<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detector - DTP AI Specialist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: #2c3e50;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar - konsisten dengan landing page */
        .navbar {
            background: #fff;
            padding: 16px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-section img {
            height: 50px;
            width: auto;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-text h1 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #C41E3A;
            line-height: 1.2;
        }

        .brand-text p {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-left: auto;
        }

        .nav-link {
            color: #555;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: color 0.2s;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-link:hover {
            color: #C41E3A;
            background: rgba(196, 30, 58, 0.05);
        }

        .nav-link.active {
            color: #C41E3A;
            background: rgba(196, 30, 58, 0.1);
            font-weight: 600;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            width: 100%;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Video Section - Elegant Card */
        .video-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .video-header {
            background: linear-gradient(135deg, #C41E3A 0%, #A01729 100%);
            color: #fff;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2c3e50;
        }

        .stat-item.in-roi .stat-value { color: #2e7d32; }
        .stat-item.outside-roi .stat-value { color: #f57c00; }
        .stat-item.fps .stat-value { color: #1976d2; }

        /* Sidebar Panel */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 14px 18px;
            border-bottom: 2px solid #C41E3A;
        }

        .panel-header h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: #C41E3A;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-body {
            padding: 18px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #C41E3A;
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #C41E3A;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(196, 30, 58, 0.3);
        }

        .range-value {
            text-align: right;
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
            font-weight: 600;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px 0;
        }

        .toggle-group label {
            margin: 0;
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background: #2e7d32;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #C41E3A 0%, #A01729 100%);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: #fff;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Objects List */
        .objects-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .object-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f9fa;
            border-left: 4px solid #C41E3A;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .object-item:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .object-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .object-count {
            background: linear-gradient(135deg, #C41E3A 0%, #A01729 100%);
            color: #fff;
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* File Upload */
        .file-upload-wrapper {
            margin-bottom: 12px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #666;
        }

        .file-upload-label:hover {
            border-color: #C41E3A;
            background: rgba(196, 30, 58, 0.05);
            color: #C41E3A;
        }

        .file-upload-input {
            display: none;
        }

        .file-name-display {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }

        /* Gallery Styles */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .gallery-item {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .gallery-item-info {
            padding: 10px;
        }

        .gallery-item-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .gallery-item-date {
            font-size: 0.75rem;
            color: #999;
        }

        .folder-browser {
            margin-bottom: 16px;
        }

        .folder-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .folder-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .folder-tab:hover {
            background: #fff;
            border-color: #C41E3A;
        }

        .folder-tab.active {
            background: linear-gradient(135deg, #C41E3A 0%, #A01729 100%);
            color: #fff;
            border-color: #C41E3A;
        }

        /* Footer - konsisten dengan landing page */
        .footer {
            background: #fff;
            padding: 24px;
            text-align: center;
            border-top: 1px solid #eee;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
        }

        .footer p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: #999;
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: #C41E3A;
        }

        .copyright {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
            color: #999;
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                gap: 12px;
            }

            .nav-link {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            .logo-section img {
                height: 40px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-links {
                display: none;
            }

            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #C41E3A;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #A01729;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo-section">
                <img src="/static/images/logo_telkom.png" alt="Telkom Schools Logo" onerror="this.style.display='none'">
                <div class="brand-text">
                    <h1>DTP AI Specialist</h1>
                    <p>SMK Telkom Sidoarjo</p>
                </div>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/detector" class="nav-link active">Detector</a>
                <a href="/gallery" class="nav-link">Gallery</a>
            </div>
            <div class="status-badge">
                <div class="status-dot"></div>
                <span id="statusText">Live Detection</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-wrapper">
        <div class="content-grid">
            <!-- Video Section -->
            <div class="video-card">
                <div class="video-header">
                    <h2>
                        <i class="fas fa-video"></i>
                        Real-time Detection
                    </h2>
                    <span id="sourceIndicator">Camera Active</span>
                </div>
                <div class="video-wrapper">
                    <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Video Feed">
                    <div class="video-overlay" id="videoOverlay">
                        <i class="fas fa-camera"></i>
                        <span id="overlayText">Camera Active</span>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat-item in-roi">
                        <div class="stat-label">In ROI</div>
                        <div class="stat-value" id="statInROI">0</div>
                    </div>
                    <div class="stat-item outside-roi">
                        <div class="stat-label">Outside ROI</div>
                        <div class="stat-value" id="statOutside">0</div>
                    </div>
                    <div class="stat-item fps">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="statFPS">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Objects</div>
                        <div class="stat-value" id="statTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Video Source -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h3><i class="fas fa-photo-video"></i> Video Source</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Select Camera</label>
                            <select id="cameraIndex">
                                <option value="0">Camera 0 (Default)</option>
                                <option value="1">Camera 1</option>
                                <option value="2">Camera 2</option>
                                <option value="3">Camera 3</option>
                                <option value="4">Camera 4</option>
                                <option value="5">Camera 5</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="useSelectedCamera()" style="margin-bottom: 12px;">
                            <i class="fas fa-video"></i> Use Selected Camera
                        </button>

                        <div class="form-group">
                            <label>IP Camera URL</label>
                            <input type="text" id="ipUrl" placeholder="http://192.168.1.20:8080/video">
                        </div>
                        <button class="btn btn-primary" onclick="useIpCamera()" style="margin-bottom: 12px;">
                            <i class="fas fa-network-wired"></i> Use IP Camera
                        </button>

                        <div class="file-upload-wrapper">
                            <label for="videoFile" class="file-upload-label">
                                <i class="fas fa-upload"></i>
                                Upload Video File
                            </label>
                            <input type="file" id="videoFile" class="file-upload-input" accept="video/*" onchange="uploadVideo()">
                            <div id="fileNameDisplay" class="file-name-display"></div>
                        </div>

                        <button class="btn btn-success" onclick="switchToCamera()" style="margin-bottom: 12px;">
                            <i class="fas fa-camera"></i> Switch to Camera
                        </button>

                        <button id="toggleCameraBtn" class="btn btn-danger" onclick="toggleCamera()">
                            <i class="fas fa-stop"></i> Stop Camera/Video
                        </button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h3><i class="fas fa-cog"></i> Detection Settings</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>ROI Position</label>
                            <select id="roiType">
                                <option value="center">Center</option>
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Confidence Threshold</label>
                            <input type="range" id="confThreshold" min="0" max="1" step="0.05" value="0.5">
                            <div class="range-value" id="confValue">0.50</div>
                        </div>

                        <div class="toggle-group">
                            <label>Show ROI Box</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showROI" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="toggle-group">
                            <label>Show Labels</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showLabels" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="toggle-group">
                            <label>Detect Emotion</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="detectEmotion" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="toggle-group">
                            <label>Flip Horizontal</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="flipHorizontal" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Detected Objects -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h3><i class="fas fa-cube"></i> Detected Objects</h3>
                    </div>
                    <div class="panel-body">
                        <div class="objects-list" id="objectsList">
                            <div class="empty-state">
                                <i class="fas fa-search" style="font-size: 2rem; color: #ccc; margin-bottom: 8px;"></i>
                                <p>No objects detected</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detected Emotions -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h3><i class="fas fa-smile"></i> Face Emotions</h3>
                    </div>
                    <div class="panel-body">
                        <div class="objects-list" id="emotionsList">
                            <div class="empty-state">
                                <i class="fas fa-meh" style="font-size: 2rem; color: #ccc; margin-bottom: 8px;"></i>
                                <p>No faces detected</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Section (Hidden by default) -->
        <div id="gallerySection" style="display: none;">
            <div class="panel-card">
                <div class="panel-header">
                    <h3><i class="fas fa-images"></i> Detection Gallery</h3>
                </div>
                <div class="panel-body">
                    <div class="folder-browser">
                        <div class="folder-tabs">
                            <div class="folder-tab active" onclick="loadGalleryFolder('objects')">
                                <i class="fas fa-cube"></i> Objects
                            </div>
                            <div class="folder-tab" onclick="loadGalleryFolder('faces')">
                                <i class="fas fa-user"></i> Faces
                            </div>
                        </div>
                    </div>
                    <div class="gallery-grid" id="galleryGrid">
                        <div class="empty-state">
                            <i class="fas fa-folder-open" style="font-size: 3rem; color: #ccc; margin-bottom: 12px;"></i>
                            <p>No images found</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p><strong>DTP AI Specialist - Kelas 11</strong></p>
            <p>SMK Telkom Sidoarjo</p>
            
            <div class="footer-links">
                <a href="https://smktelkom-sid.sch.id" class="footer-link" target="_blank">Website Sekolah</a>
                <a href="#" class="footer-link">Dokumentasi</a>
                <a href="#" class="footer-link">Kontak</a>
            </div>

            <div class="copyright">
                &copy; 2025 SMK Telkom Sidoarjo. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Enable saving when on detector page
        window.addEventListener('load', function() {
            fetch('/set_save_mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: true})
            });
            initAutoCamera();
            updateStats();
            updateStatusUI();
            setInterval(updateStats, 3000);  // Optimized: reduced polling frequency
            setInterval(updateStatusUI, 5000);  // Optimized: reduced polling frequency
        });

        // Disable saving when leaving detector page
        window.addEventListener('beforeunload', function() {
            fetch('/set_save_mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: false})
            });
        });

        // Auto-select best available camera
        function initAutoCamera() {
            fetch('/list_cameras')
                .then(response => response.json())
                .then(data => {
                    if (data.cameras && data.cameras.length > 0) {
                        const bestCamera = data.cameras[0];
                        document.getElementById('cameraIndex').value = bestCamera.index;
                        useSelectedCamera();
                    }
                })
                .catch(err => console.log('Camera detection:', err));
        }

        // Update statistics
        function updateStats() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('statInROI').textContent = data.in_roi || 0;
                    document.getElementById('statOutside').textContent = data.outside_roi || 0;
                    document.getElementById('statFPS').textContent = data.fps || 0;
                    document.getElementById('statTotal').textContent = data.total_objects || 0;

                    // Update objects list
                    const objectsList = document.getElementById('objectsList');
                    if (data.detected_objects && Object.keys(data.detected_objects).length > 0) {
                        let html = '';
                        for (const [obj, count] of Object.entries(data.detected_objects)) {
                            html += `
                                <div class="object-item">
                                    <span class="object-name">${obj}</span>
                                    <span class="object-count">${count}</span>
                                </div>
                            `;
                        }
                        objectsList.innerHTML = html;
                    } else {
                        objectsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search" style="font-size: 2rem; color: #ccc; margin-bottom: 8px;"></i>
                                <p>No objects detected</p>
                            </div>
                        `;
                    }

                    // Update emotions list
                    const emotionsList = document.getElementById('emotionsList');
                    if (data.detected_emotions && Object.keys(data.detected_emotions).length > 0) {
                        let html = '';
                        for (const [emotion, count] of Object.entries(data.detected_emotions)) {
                            html += `
                                <div class="object-item">
                                    <span class="object-name">${emotion}</span>
                                    <span class="object-count">${count}</span>
                                </div>
                            `;
                        }
                        emotionsList.innerHTML = html;
                    } else {
                        emotionsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-meh" style="font-size: 2rem; color: #ccc; margin-bottom: 8px;"></i>
                                <p>No faces detected</p>
                            </div>
                        `;
                    }
                })
                .catch(err => console.log('Stats update error:', err));
        }

        // Update status UI
        function updateStatusUI() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusText = document.getElementById('statusText');
                    const sourceIndicator = document.getElementById('sourceIndicator');
                    const overlayText = document.getElementById('overlayText');
                    const toggleBtn = document.getElementById('toggleCameraBtn');

                    if (data.camera_active) {
                        statusText.textContent = 'Live Detection';
                        toggleBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Camera/Video';
                        toggleBtn.className = 'btn btn-danger';
                        
                        if (data.video_mode) {
                            sourceIndicator.textContent = 'Video File';
                            overlayText.innerHTML = '<i class="fas fa-file-video"></i> Video File';
                        } else if (data.ip_mode) {
                            sourceIndicator.textContent = 'IP Camera';
                            overlayText.innerHTML = '<i class="fas fa-network-wired"></i> IP Camera';
                        } else {
                            sourceIndicator.textContent = 'Camera Active';
                            overlayText.innerHTML = '<i class="fas fa-camera"></i> Camera Active';
                        }
                    } else {
                        statusText.textContent = 'Stopped';
                        sourceIndicator.textContent = 'Inactive';
                        overlayText.innerHTML = '<i class="fas fa-pause-circle"></i> Stopped';
                        toggleBtn.innerHTML = '<i class="fas fa-play"></i> Start Camera';
                        toggleBtn.className = 'btn btn-success';
                    }
                })
                .catch(err => console.log('Status update error:', err));
        }

        // Toggle camera
        function toggleCamera() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.camera_active) {
                        fetch('/stop', { method: 'POST' })
                            .then(() => {
                                updateStatusUI();
                            });
                    } else {
                        fetch('/start', { method: 'POST' })
                            .then(() => {
                                updateStatusUI();
                            });
                    }
                });
        }

        // Use selected camera
        function useSelectedCamera() {
            const index = document.getElementById('cameraIndex').value;
            fetch('/camera_index', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: parseInt(index) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatusUI();
                } else {
                    alert('Failed to switch camera: ' + data.message);
                }
            });
        }

        // Use IP camera
        function useIpCamera() {
            const url = document.getElementById('ipUrl').value;
            if (!url) {
                alert('Please enter an IP camera URL');
                return;
            }
            fetch('/use_ip_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateStatusUI();
                } else {
                    alert('Failed to connect to IP camera: ' + data.message);
                }
            });
        }

        // Switch to camera
        function switchToCamera() {
            fetch('/switch_to_camera', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStatusUI();
                    }
                });
        }

        // Upload video
        function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('video', file);

            document.getElementById('fileNameDisplay').textContent = 'Uploading: ' + file.name;

            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('fileNameDisplay').textContent = 'Uploaded: ' + file.name;
                    updateStatusUI();
                } else {
                    alert('Upload failed: ' + data.message);
                }
            })
            .catch(err => {
                alert('Upload error: ' + err);
            });
        }

        // Settings change handlers
        document.getElementById('roiType').addEventListener('change', function() {
            updateSetting('roi_type', this.value);
        });

        document.getElementById('confThreshold').addEventListener('input', function() {
            document.getElementById('confValue').textContent = parseFloat(this.value).toFixed(2);
            updateSetting('conf_threshold', parseFloat(this.value));
        });

        document.getElementById('showROI').addEventListener('change', function() {
            updateSetting('show_roi', this.checked);
        });

        document.getElementById('showLabels').addEventListener('change', function() {
            updateSetting('show_labels', this.checked);
        });

        document.getElementById('detectEmotion').addEventListener('change', function() {
            updateSetting('detect_emotion', this.checked);
        });

        document.getElementById('flipHorizontal').addEventListener('change', function() {
            updateSetting('flip_horizontal', this.checked);
        });

        function updateSetting(key, value) {
            const data = {};
            data[key] = value;
            fetch('/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // Gallery functions
        function showGallery() {
            const gallerySection = document.getElementById('gallerySection');
            if (gallerySection.style.display === 'none') {
                gallerySection.style.display = 'block';
                loadGalleryFolder('objects');
            } else {
                gallerySection.style.display = 'none';
            }
        }

        function loadGalleryFolder(type) {
            // Update active tab
            document.querySelectorAll('.folder-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.folder-tab').classList.add('active');

            // Load gallery images
            fetch(`/gallery/${type}`)
                .then(response => response.json())
                .then(data => {
                    const galleryGrid = document.getElementById('galleryGrid');
                    
                    if (data.images && data.images.length > 0) {
                        let html = '';
                        data.images.forEach(img => {
                            html += `
                                <div class="gallery-item">
                                    <img src="${img.path}" alt="${img.name}">
                                    <div class="gallery-item-info">
                                        <div class="gallery-item-title">${img.name}</div>
                                        <div class="gallery-item-date">${img.date}</div>
                                    </div>
                                </div>
                            `;
                        });
                        galleryGrid.innerHTML = html;
                    } else {
                        galleryGrid.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-folder-open" style="font-size: 3rem; color: #ccc; margin-bottom: 12px;"></i>
                                <p>No images found in ${type}</p>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    console.log('Gallery load error:', err);
                    document.getElementById('galleryGrid').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f57c00; margin-bottom: 12px;"></i>
                            <p>Error loading gallery</p>
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>
